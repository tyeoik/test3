import streamlit as st
from openai import OpenAI
import os

# =========================================================
# 1. í™˜ê²½ ì„¤ì • ë° API í‚¤ ê´€ë¦¬
# =========================================================

# Streamlit Secretsì—ì„œ API Key ê°€ì ¸ì˜¤ê¸°
# Streamlit Cloud í™˜ê²½ì—ì„œëŠ” st.secrets["OPENAI_API_KEY"]ë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤.
try:
    # st.secretsì— í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
    openai_api_key = st.secrets["OPENAI_API_KEY"]
except KeyError:
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë˜ëŠ” secrets ì„¤ì • ì „ì„ ìœ„í•œ ì•ˆë‚´
    st.error("ğŸš¨ OpenAI API í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    st.markdown("""
        **[Streamlit Cloud ë°°í¬ ì‹œ]**
        1. í”„ë¡œì íŠ¸ Secretsì— `OPENAI_API_KEY` ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ ì£¼ì„¸ìš”.
        2. ê°’ì€ ì‹¤ì œ OpenAI API Secret Keyë¥¼ ë„£ì–´ì£¼ì„¸ìš”.
        
        **[ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ]**
        `.streamlit/secrets.toml` íŒŒì¼ì„ ìƒì„±í•˜ê³  `OPENAI_API_KEY = "sk-..."`ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, 
        í™˜ê²½ ë³€ìˆ˜ì— ì§ì ‘ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
    """)
    st.stop() # í‚¤ê°€ ì—†ìœ¼ë©´ ì•± ì‹¤í–‰ ì¤‘ì§€

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
# st.secretsë¥¼ ì‚¬ìš©í•˜ë©´ keyê°€ ìë™ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
client = OpenAI(api_key=openai_api_key)

# =========================================================
# 2. í•µì‹¬ ê¸°ëŠ¥: ê³µë¬¸ì„œ ìƒì„± í•¨ìˆ˜
# =========================================================
def generate_official_document(subject_content):
    """
    OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ êµì‚¬ìš© ê³µë¬¸ì„œ ì´ˆì•ˆì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜.
    """
    
    # ëª¨ë¸ì— ì „ë‹¬í•  í”„ë¡¬í”„íŠ¸ ì •ì˜
    # 'System' ì—­í• ì„ ë¶€ì—¬í•˜ì—¬ ëª¨ë¸ì˜ í˜ë¥´ì†Œë‚˜ì™€ í˜•ì‹ì„ ëª…í™•íˆ ì§€ì •í•©ë‹ˆë‹¤.
    system_prompt = (
        "ë‹¹ì‹ ì€ êµìœ¡ í–‰ì • ì „ë¬¸ê°€ì´ë©°, í•™êµ êµì‚¬ë¥¼ ìœ„í•œ ê³µì‹ì ì´ê³  ê²©ì‹ ìˆëŠ” "
        "ê³µë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ëŠ” ì—­í• ì„ ë§¡ê³  ìˆìŠµë‹ˆë‹¤. "
        "ë‹¤ìŒê³¼ ê°™ì€ ë‚´ìš©ì„ í¬í•¨í•˜ì—¬ 'ì œëª©', 'ê´€ë ¨', 'ëª©ì ', 'ë‚´ìš©' ë“±ì˜ í•­ëª©ì„ ê°–ì¶˜ "
        "ë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ë¬¸ì¥ì€ ëª…ë£Œí•˜ê³  ì •ì¤‘í•˜ë©°, êµ°ë”ë”ê¸° ì—†ì´ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤."
    )
    
    # ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„± ìš”ì²­
    user_prompt = f"ë‹¤ìŒ ì£¼ì œì— ëŒ€í•œ ê³µë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì„¸ìš”: {subject_content}"
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini", # ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ ëª¨ë¸ ì„ íƒ
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.7, # ì°½ì˜ì„±ê³¼ ì•ˆì •ì„± ì¤‘ê°„ê°’ ì„¤ì •
        )
        # ìƒì„±ëœ í…ìŠ¤íŠ¸ ë°˜í™˜
        return response.choices[0].message.content
        
    except Exception as e:
        return f"API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"

# =========================================================
# 3. Streamlit ì•± ë ˆì´ì•„ì›ƒ
# =========================================================

st.set_page_config(page_title="êµì‚¬ìš© ê³µë¬¸ì„œ ìë™ ìƒì„±ê¸°", layout="wide")
st.title("ğŸ“„ í•™êµ êµì‚¬ìš© ê³µë¬¸ì„œ ìë™ ìƒì„±ê¸°")
st.markdown("---")

# ì‚¬ìš©ì ì…ë ¥ ìœ„ì ¯
st.subheader("ğŸ“ ê³µë¬¸ì„œ ì£¼ì œ ë° í•µì‹¬ ë‚´ìš© ì…ë ¥")
subject_input = st.text_area(
    "ìƒì„±í•  ê³µë¬¸ì„œì˜ ì£¼ì œë‚˜ í•µì‹¬ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.",
    placeholder="ì˜ˆì‹œ: 3í•™ë…„ í˜„ì¥ì²´í—˜í•™ìŠµ ë¯¸ì‹ ì²­ í•™ìƒë“¤ì„ ìœ„í•œ ëŒ€ì²´í•™ìŠµ ìš´ì˜ ì•ˆë‚´",
    height=150
)

# ë²„íŠ¼
if st.button("ğŸš€ ê³µë¬¸ì„œ ì´ˆì•ˆ ìƒì„± ì‹œì‘", type="primary"):
    if subject_input:
        # ì§„í–‰ ìƒí™© í‘œì‹œ
        with st.spinner("âœ¨ OpenAIê°€ ê³µë¬¸ì„œ ì´ˆì•ˆì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”."):
            # ê³µë¬¸ì„œ ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ
            document_draft = generate_official_document(subject_input)
            
        st.markdown("---")
        st.subheader("âœ… ìƒì„±ëœ ê³µë¬¸ì„œ ì´ˆì•ˆ")
        
        # ê²°ê³¼ë¥¼ ë¸”ë¡ìœ¼ë¡œ í‘œì‹œí•˜ì—¬ ë³µì‚¬í•˜ê¸° ì‰½ê²Œ í•¨
        st.code(document_draft, language="markdown")
        
        st.success("ì´ˆì•ˆ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ í™•ì¸ í›„ ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.")
    else:
        st.warning("ì£¼ì œ ë˜ëŠ” í•µì‹¬ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!")
